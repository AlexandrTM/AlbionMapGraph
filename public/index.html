<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Real-time Map Connections</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        rect { stroke: #333; stroke-width: 2px; rx: 10; ry: 10; }
        line { stroke: #555; stroke-width: 2px; marker-end: url(#arrow); }
        text { font: 12px sans-serif; pointer-events: none; }
    </style>
</head>
<body>
<svg id="map" width="1000" height="600"></svg>
<script>
    const svg = d3.select("#map");
    const defs = svg.append("defs");
    defs.append("marker")
        .attr("id","arrow")
        .attr("viewBox","0 -5 10 10")
        .attr("refX",15)
        .attr("refY",0)
        .attr("markerWidth",6)
        .attr("markerHeight",6)
        .attr("orient","auto")
        .append("path")
        .attr("d","M0,-5L10,0L0,5")
        .attr("fill","#555");

    const width = +svg.attr("width"), height = +svg.attr("height");
    const nodeSize = { w: 120, h: 40 };
    let lastETag = "";

    async function updateMap() {
        const res = await fetch('/map.json', {
            headers: lastETag ? { 'If-None-Match': lastETag } : {}
        });

        if (res.status === 304) {
            //console.log("nothing changed");
            return;
        }

        lastETag = res.headers.get('ETag');
        const data = await res.json();
        renderGraph(data);
    }

    async function renderGraph(data){
        const links = data.map(c => ({ source: c.from.id, target: c.to.id }));

        const nodesMap = {};
        data.forEach(c => {
            nodesMap[c.from.id] = c.from;
            nodesMap[c.to.id] = c.to;
        });
        const nodes = Object.values(nodesMap);

        // Clear previous contents
        svg.selectAll('*:not(defs)').remove();

        // Create simulation
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(160))
            .force("charge", d3.forceManyBody().strength(-400))
            .force("center", d3.forceCenter(width / 2, height / 2));

        // Draw lines
        const link = svg.append("g")
            .attr("stroke", "#999")
            .attr("stroke-opacity", 0.6)
            .selectAll("line")
            .data(links)
            .enter().append("line")
            .attr("stroke-width", 2)
            .attr("marker-end", "url(#arrow)");

        // Draw rectangles
        const node = svg.append("g")
            .selectAll("g")
            .data(nodes)
            .enter().append("g");

        node.append("rect")
            .attr("width", nodeSize.w)
            .attr("height", nodeSize.h)
            .attr("rx", 10)
            .attr("ry", 10)
            .attr("fill", d => d.id.startsWith("TNL") ? "#6ab1f7" : "#91e291")
            .attr("stroke", "#333")
            .attr("stroke-width", 2);

        node.append("text")
            .attr("x", nodeSize.w / 2)
            .attr("y", nodeSize.h / 2 + 4)
            .attr("text-anchor", "middle")
            .text(d => d.name);

        // Simulation tick updates positions
        simulation.on("tick", () => {
            node.attr("transform", d => `translate(${d.x - nodeSize.w / 2}, ${d.y - nodeSize.h / 2})`);
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);
        });
    }

    updateMap();
    setInterval(updateMap, 2000); // refresh every 2 seconds
</script>
</body>
</html>
